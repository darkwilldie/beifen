#' plot_sub_image
#'
#' plot_sub_image draws the spatially resolved single cells with cell typing onto the histology image
#'
#' @param im an image object generated by the magick::image_read() function
#' @param im_path a character value, representing the the path of the image file
#' @param image_transparency a numeric value ranging from 0 to 1, representing the transparency to plot the image
#' @param w a numeric value representing the width for image cropping
#' @param h a numeric value representing the height for image cropping
#' @param xoff a numeric value representing the x-axis offset for image cropping
#' @param yoff a numeric value representing the y-axis offset for image cropping
#' @param x_scale a numeric value from 0 to 1, representing the scalling factor for resizing image
#' @param plot_spot a boolean value representing whether to plot the spot
#' @param spot_radius a numeric value representing the spot radius
#' @param fct  a numeric value representing the ratio between spot radius and spot center distance (for calculating spot radius)
#' @param spot_coordinates a data frame representing the spot coordinates, where barcode indicates the spot id
#' @param plot_cell a boolean value representing whether to plot the cell contour
#' @param contour a list of cell contours, where each item is a data frame representing the contour coordinates
#' @param cell_types a vector of character values, with the names being the cell ids
#' @param color_use a vector of character values representing the colors to plot the cell contour
#' @param axis_tick a numeric values representing the interval between two ticks
#' @param axis_col a character value representing the color of axis
#' @param spot_cols a vector of character values representing the colors of spots
#' @param fill_spot  a boolean value representing whether to fill in the spot
#'
#' @return
#' @export
#'
#' @author Shijia Zhu, \email{shijia.zhu@@utsouthwestern.edu}
#'
#' @seealso \code{\link{get_my_colors}}; \code{\link{STIE}}; \code{\link{merge_feature}};
#'
#'

library(magick)
library(EBImage)

source("./R_plot/calculate_spot_radius.R")
source("./R_plot/get_my_colors.R")

args <- commandArgs(T)
if (args[1] == "mouse") {
    args[1] <- "Mouse_brain_hippocampus_STexpr_cellSegmentation"
}
print(args[1])
dataset <- args[1]
# dataset <- "Mouse_brain_hippocampus_STexpr_cellSegmentation"
# dataset <- "test_1000"
# dataset <- "section2"
data_dir <- "./plot_csv/"

plot_sub_image <- function(im = NULL, im_path = NULL, image_transparency = 0, w = NULL, h = NULL, xoff = 0, yoff = 0, x_scale = 1,
                           cell_coordinates = NULL,
                           plot_spot = F, spot_radius = NULL, fct = 0.25, spot_coordinates = NULL,
                           plot_cell = T, contour = NULL, cell_types = NULL,
                           color_use = NULL, axis_tick = 0, axis_col = "grey", spot_cols = "white", fill_spot = FALSE,
                           cell_coordinates_size = 10) {
    if (is.null(im)) {
        #  cat("Reading", image, "...\n")
        print("reading")
        im <- image_read(path = im_path)
        print("reading done")
    }

    if (!is.null(w) & !is.null(h)) {
        im <- im %>% image_crop(geometry = geometry_area(width = w, height = h, x_off = xoff, y_off = yoff))
    } else {
        iminf <- image_info(im)
        w <- iminf$width
        h <- iminf$height
    }

    if (x_scale < 1) {
        iminf <- image_info(im)
        print(paste0("Image width: ", iminf$width))
        print(paste0("Image width after scaling: ", x_scale * iminf$width))
        im <- im %>%
            image_scale(paste0(round(x_scale * iminf$width)))
    }
    im <- im %>%
        as_EBImage()
    # print(cell_types)


    uni_celltypes <- sort(unique(as.character(cell_types)))
    # print(uni_celltypes)

    cellids <- names(cell_types)

    # print(cellids)

    num_celltypes <- table(cell_types)
    # print(num_celltypes)
    num_celltypes <- num_celltypes[match(uni_celltypes, names(num_celltypes))]
    # print(num_celltypes)
    n <- length(uni_celltypes)

    if (is.null(color_use)) {
        color_use <- get_my_colors(n, mode = 2)
    }

    cell_cols <- rep(1, length(cell_types))
    for (i in 1:n) cell_cols[cell_types == uni_celltypes[i]] <- color_use[i]

    # spot_cols = rep(0,length(spot_types))
    # for(i in 1:n) spot_cols[spot_types==uni_celltypes[i]] = color_use[i]

    mat1 <- matrix(1:2, ncol = 2, nrow = 1)
    layout(mat1, widths = c(8, 2), heights = c(1, 2))

    if (image_transparency >= 0 & image_transparency <= 1) {
        im <- (1 - image_transparency) * im + image_transparency * (im * 0 + 1)
        display(im, method = "raster")
    }

    if (plot_spot) {
        plot_spot_info(spot_coordinates, w, h, xoff, yoff, x_scale,
            spot_cols = spot_cols, barcode = F,
            spot_radius = spot_radius, fct = fct, fill_spot = fill_spot
        )
    }

    if (axis_tick > 0) {
        w_scaled <- dim(im)[1]
        h_scaled <- dim(im)[2]
        x_at <- ceiling(xoff / axis_tick) * axis_tick - xoff + c(1:ceiling(w_scaled / x_scale / axis_tick)) * axis_tick
        y_at <- ceiling(yoff / axis_tick) * axis_tick - yoff + c(1:ceiling(h_scaled / x_scale / axis_tick)) * axis_tick
        x_label <- ceiling(xoff / axis_tick) * axis_tick + x_at
        y_label <- ceiling(yoff / axis_tick) * axis_tick + y_at
        axis(1, pos = c(0, 0), at = x_at * x_scale, label = x_label)
        axis(2, pos = c(0, 0), at = y_at * x_scale, label = y_label)

        tmp <- sapply(x_at * x_scale, function(x) abline(h = x, lty = 2, col = axis_col))
        tmp <- sapply(y_at * x_scale, function(x) abline(v = x, lty = 2, col = axis_col))
    }

    if (plot_cell) {
        plot_cell_contour(contour, cell_coordinates, w, h, xoff, yoff, x_scale, cell_cols, cell_coordinates_size = cell_coordinates_size)
        par(mar = c(0, 0, 0, 0))
        plot.new()
        legend <- paste0(uni_celltypes, " (", num_celltypes, ")")
        legend("topleft",
            legend = legend, pch = 16, col = color_use,
            box.lwd = 0, box.col = "white", bg = "white"
        )
    }
}


#' plot_cell_contour
#'
#' @param contour a list of matrics with each item representing one cell contour
#' @param cell_coordinates a matix of numeric values represensting the coordinate of each cell, where columns "pixel_x" and "pixel_y" represent the x and y coordinates, respectively
#' @param w an integer value representing the width for cropping the image
#' @param h an integer value representing the height for cropping the image
#' @param xoff an integer value representing the offset on X-axis for cropping the image
#' @param yoff an integer value representing the offset on Y-axis for cropping the image
#' @param x_scale a numeric value from 0 to 1 for resizing the image
#' @param cell_cols  a vector of character values representing colors to plot cell types, which ara ranked based on alphabetical order
#'
#' @author Shijia Zhu, \email{shijia.zhu@@utsouthwestern.edu}
#' @export
#'
plot_cell_contour <- function(contour, cell_coordinates, w, h, xoff, yoff, x_scale, cell_cols, cell_coordinates_size) {
    if (is.null(contour)) {
        points((cell_coordinates$X - xoff) * x_scale, (cell_coordinates$Y - yoff) * x_scale, col = cell_cols, cex = cell_coordinates_size)
    } else {
        for (i in 1:length(contour))
        {
            x <- (as.numeric(contour[[i]][, 1]) - xoff) * x_scale
            y <- (as.numeric(contour[[i]][, 2]) - yoff) * x_scale
            if (any(x > 0) & any(x < w) & any(y > 0) & any(y < h)) lines(x, y, col = cell_cols[i]) #
        }
    }
}


plot_spot_info <- function(spot_coordinates, w = NULL, h = NULL, xoff = 0, yoff = 0, x_scale,
                           spot_cols = "white", barcode = T, spot_radius = NULL, fct = 0.25, fill_spot = FALSE) {
    if (length(spot_cols) == 1) spot_cols <- rep(spot_cols, nrow(spot_coordinates))

    plot_circle <- function(x, y, r, c) {
        angles <- seq(0, 2 * pi, length.out = 360)
        lines(r * cos(angles) + x, r * sin(angles) + y, col = c, lwd = 1)
    }

    if (all(c("X", "Y") %in% colnames(spot_coordinates))) {
        spot_coordinates$pixel_x <- (spot_coordinates$X - xoff) * x_scale
        spot_coordinates$pixel_y <- (spot_coordinates$Y - yoff) * x_scale
    }

    if (all(c("imagecol", "imagerow") %in% colnames(spot_coordinates))) {
        if (!is.null(w) & !is.null(h)) {
            spot_coordinates <- subset(
                spot_coordinates,
                imagecol >= xoff & imagecol <= (xoff + w) &
                    imagerow >= yoff & imagerow <= (yoff + h)
            )
        }
        spot_coordinates$pixel_x <- (spot_coordinates$imagecol - xoff) * x_scale
        spot_coordinates$pixel_y <- (spot_coordinates$imagerow - yoff) * x_scale
    }

    if (is.null(spot_radius)) {
        spot_radius <- calculate_spot_radius(spot_coordinates, fct)
    } else {
        spot_radius <- spot_radius * x_scale
    }
    cat("spot_radius:", spot_radius, "\n")

    for (i in 1:nrow(spot_coordinates)) {
        x <- as.numeric(spot_coordinates[i, "pixel_x"])
        y <- as.numeric(spot_coordinates[i, "pixel_y"])
        r <- spot_radius
        c <- spot_cols[i]
        if (fill_spot) {
            library(plotrix)
            draw.circle(x, y, r, col = c, border = c)
        } else {
            plot_circle(x, y, r, c)
        }

        # text(x, y-r, as.character(spot_coordinates$barcode[i]) )
        if (barcode) text(x, y - r, rownames(spot_coordinates)[i])
    }
}

if (sys.nframe() == 0) {
    # im_path <- "/home/yanghl/zhushijia/model_new_zhu/model_tangram_test/plot_csv/section2/sum_CytAssist_FFPE_Mouse_Brain_Rep1_tissue_image.jpg"
    # im_path <- "E:/Omics/beifen/plot_csv/Mouse_brain_hippocampus_STexpr_cellSegmentation/sum_CytAssist_FFPE_Mouse_Brain_Rep1_tissue_image.jpg"
    im_path <- paste0(data_dir, dataset, "/sum_CytAssist_FFPE_Mouse_Brain_Rep1_tissue_image.jpg")
    # model_test1  /home/yanghl/zhushijia/model_new_zhu/test_my_/plot_csv/section1/sum_cell_coordinates.csv   general_model   model_tangram_test
    # cell_data <- read.csv("/home/yanghl/zhushijia/model_new_zhu/model_tangram_test/plot_csv/section2/sum_spot_cell_type.csv")
    # cell_data <- read.csv("E:/Omics/beifen/plot_csv/Mouse_brain_hippocampus_STexpr_cellSegmentation/sum_spot_cell_type.csv")
    cell_data <- read.csv(paste0(data_dir, dataset, "/sum_spot_cell_type.csv"))
    cell_data$type <- factor(cell_data$type, levels = unique(cell_data$type))
    cell_data <- cell_data$type


    # <U+8BFB><U+53D6><U+7EC6><U+80DE><U+5750><U+6807><U+6570><U+636E>
    # cell_coordinates <- read.csv("/home/yanghl/zhushijia/model_new_zhu/model_tangram_test/plot_csv/section2/sum_cell_coordinates.csv")
    # cell_coordinates <- read.csv("E:/Omics/beifen/plot_csv/Mouse_brain_hippocampus_STexpr_cellSegmentation/sum_cell_coordinates.csv")
    cell_coordinates <- read.csv(paste0(data_dir, dataset, "/sum_cell_coordinates.csv"))

    # colors <- c("magenta", "blue", "green", "black", "orange")
    #    colors = c("orange", "red", "black", "magenta", "yellow", "brown", "green", "purple", "blue")
    if (startsWith(dataset, "test")) {
        colors <- c("orange", "red", "black", "magenta", "yellow", "brown", "green", "purple", "blue")
    } else {
        colors <- c("magenta", "blue", "green", "black", "orange")
    }

    if (dataset == "section1") {
        #     section1
        plot_sub_image(
            im_path = im_path, w = 900, h = 500, xoff = 1550, yoff = 1150,
            cell_coordinates = cell_coordinates,
            contour = NULL, cell_types = cell_data, color_use = colors,
            plot_spot = F, plot_cell = T, cell_coordinates_size = 0.1
        )
    } else if (dataset == "section2") {
        # section2
        plot_sub_image(
            im_path = im_path, w = 820, h = 450, xoff = 1100, yoff = 730,
            cell_coordinates = cell_coordinates,
            contour = NULL, cell_types = cell_data, color_use = colors,
            plot_spot = F, plot_cell = T, cell_coordinates_size = 0.1
        )
    } else if (dataset == "Mouse_brain_hippocampus_STexpr_cellSegmentation") {
        # Mouse_brain_hippocampus_STexpr_cellSegmentation
        plot_sub_image(
            im_path = im_path, w = 600, h = 500, xoff = 800, yoff = 1050,
            cell_coordinates = cell_coordinates,
            contour = NULL, cell_types = cell_data, color_use = colors,
            plot_spot = F, plot_cell = T, cell_coordinates_size = 0.1
        )
    } else if (startsWith(dataset, "test")) {
        #    human
        plot_sub_image(
            im_path = im_path,
            cell_coordinates = cell_coordinates,
            contour = NULL, cell_types = cell_data, color_use = colors,
            plot_spot = F, plot_cell = T, cell_coordinates_size = 0.01
        )
    }
}
